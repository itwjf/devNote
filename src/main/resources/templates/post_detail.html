<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title th:text="${post.title}">æ–‡ç« è¯¦æƒ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- æœ¬åœ° Bootstrap -->
  <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body class="bg-light">
<div class="site-shell">

  <!-- ========== å¯¼èˆªæ  ========== -->
  <header th:replace="~{fragments/header :: navbar}"></header>

  <!-- ========== ä¸»å†…å®¹åŒº ========== -->
  <main class="main-content">
    <div class="container">
      <article class="post-detail-card bg-white p-5 rounded-3 shadow-sm border">
        <!-- æ ‡é¢˜ -->
        <h1 class="h2 mb-4 fw-bold text-dark" th:text="${post.title}">æ–‡ç« æ ‡é¢˜</h1>

        <!-- å…ƒä¿¡æ¯ -->
        <div class="d-flex flex-wrap align-items-center gap-3 mb-4 text-muted">
          <div>
            <i class="bi bi-person-circle"></i>
            <a th:href="@{'/user/' + ${post.author.username}}"
               class="text-decoration-none text-primary fw-medium"
               th:text="${post.author.username}">ä½œè€…</a>
          </div>
          <div>
            <i class="bi bi-calendar-event"></i>
            <span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</span>
          </div>
          <div class="badge bg-info text-dark">
            <i class="bi bi-eye"></i>
            <span th:switch="${post.visibility}">
                            <span th:case="'PUBLIC'">å…¬å¼€</span>
                            <span th:case="'FOLLOWERS'">ç²‰ä¸å¯è§</span>
                            <span th:case="'PRIVATE'">ä»…è‡ªå·±</span>
                        </span>
          </div>
        </div>

        <!-- ç‚¹èµ & æ”¶è— -->
        <div class="d-flex gap-3 mb-4">
          <button id="like-btn" data-post-id="[[${post.id}]]" class="btn btn-outline-secondary d-flex align-items-center gap-1">
            <i class="bi bi-heart"></i> <span>ç‚¹èµ</span>
          </button>
          <span id="like-count" class="align-self-center text-muted" th:text="${likeCount}">0</span>

          <button id="favorite-btn" data-post-id="[[${post.id}]]" class="btn btn-outline-secondary d-flex align-items-center gap-1">
            <i class="bi bi-star"></i> <span>æ”¶è—</span>
          </button>
          <span id="favorite-count" class="align-self-center text-muted" th:text="${favoriteCount}">0</span>
        </div>

        <!-- æ–‡ç« å†…å®¹ -->
        <div class="post-content fs-5 mb-5" th:utext="${post.content}">
          æ–‡ç« å†…å®¹...
        </div>

        <!-- æ“ä½œæŒ‰é’®ï¼ˆç¼–è¾‘/åˆ é™¤ï¼‰ -->
        <div th:if="${currentUsername == post.author.username}" class="d-flex gap-2 mb-4">
          <a th:href="@{'/posts/' + ${post.id} + '/edit'}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-pencil"></i> ç¼–è¾‘
          </a>
          <form th:action="@{'/posts/' + ${post.id} + '/delete'}" method="post" style="display:inline;"
                onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')">
            <button type="submit" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-trash"></i> åˆ é™¤
            </button>
          </form>
        </div>

        <hr class="my-5">

        <!-- è¯„è®ºåŒº -->
        <section class="comments-section">
          <h2 class="h4 mb-4 fw-bold">ğŸ’¬ è¯„è®º (<span th:text="${#lists.size(post.comments)}">0</span>)</h2>

          <!-- æ— è¯„è®º -->
          <p th:if="${#lists.isEmpty(post.comments)}" class="text-muted">
            è¿˜æ²¡æœ‰è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼
          </p>

          <!-- è¯„è®ºåˆ—è¡¨ -->
          <div th:each="comment : ${post.comments}" class="comment mb-4 p-3 rounded border">
            <div class="d-flex justify-content-between">
              <div>
                <strong class="text-primary" th:text="${comment.author.username}">è¯„è®ºè€…</strong>
                <small class="text-muted ms-2"
                       th:text="${#temporals.format(comment.createdAt, 'MM-dd HH:mm')}">01-01 12:00</small>
              </div>
              <!-- åˆ é™¤æŒ‰é’® -->
              <form th:if="${currentUsername == comment.author.username || currentUsername == post.author.username}"
                    th:action="@{'/posts/' + ${post.id} + '/comments/' + ${comment.id} + '/delete'}"
                    method="post"
                    onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ');"
                    class="d-inline">
                <button type="submit" class="btn btn-sm btn-link text-danger p-0">åˆ é™¤</button>
              </form>
            </div>
            <p class="mt-2 mb-2" th:text="${comment.content}">è¯„è®ºå†…å®¹</p>

            <!-- å­è¯„è®º -->
            <div th:if="${not #lists.isEmpty(comment.replies)}" class="mt-3 ps-3 border-start border-secondary-subtle">
              <div th:each="reply : ${comment.replies}" class="reply mb-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong class="text-success" th:text="${reply.author.username}">å›å¤è€…</strong>
                    <small class="text-muted ms-2"
                           th:text="${#temporals.format(reply.createdAt, 'MM-dd HH:mm')}">01-01 12:00</small>
                  </div>
                  <form th:if="${currentUsername == reply.author.username || currentUsername == post.author.username}"
                        th:action="@{'/posts/' + ${post.id} + '/comments/' + ${reply.id} + '/delete'}"
                        method="post"
                        onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å›å¤å—ï¼Ÿ');"
                        class="d-inline">
                    <button type="submit" class="btn btn-sm btn-link text-danger p-0">åˆ é™¤</button>
                  </form>
                </div>
                <p class="mt-1" th:text="${reply.content}">å›å¤å†…å®¹</p>
              </div>
            </div>

            <!-- å›å¤è¡¨å• -->
            <div th:if="${currentUsername != null}" class="mt-3">
              <form th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post" class="d-flex gap-2">
                                <textarea name="content" rows="2" class="form-control form-control-sm"
                                          th:placeholder="'å›å¤ '+ ${comment.author.username} + 'ï¼š'"
                                          required></textarea>
                <input type="hidden" name="parentId" th:value="${comment.id}"/>
                <button type="submit" class="btn btn-sm btn-gradient align-self-end">å›å¤</button>
              </form>
            </div>
          </div>
        </section>

        <hr class="my-5">

        <!-- å‘è¡¨æ–°è¯„è®º -->
        <div th:if="${currentUsername != null}" class="new-comment-form">
          <h3 class="h5 mb-3">âœï¸ å‘è¡¨è¯„è®º</h3>
          <form th:action="@{'/posts/' + ${post.id} + '/comments'}" method="post">
            <textarea name="content" rows="3" class="form-control mb-2" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." required></textarea>
            <button type="submit" class="btn btn-gradient">æäº¤è¯„è®º</button>
          </form>
        </div>

        <p th:if="${currentUsername == null}" class="text-center text-muted mt-4">
          <a th:href="@{/login}" class="text-primary">ç™»å½•</a> åæ‰èƒ½å‘è¡¨è¯„è®ºã€‚
        </p>

        <div class="mt-5 text-center">
          <a th:href="@{/}" class="btn btn-outline-secondary">&larr; è¿”å›é¦–é¡µ</a>
        </div>
      </article>
    </div>
  </main>
</div>

<!-- Bootstrap JS -->
<script th:src="@{/js/bootstrap.bundle.min.js}"></script>

<!-- ========================= -->
<!-- JavaScript é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ -->
<!-- ========================= -->
<script th:inline="javascript">
  document.addEventListener("DOMContentLoaded", function () {
    const postId = /*[[${post.id}]]*/ 0;

    const likeBtn = document.getElementById("like-btn");
    const likeCountSpan = document.getElementById("like-count");
    const favoriteBtn = document.getElementById("favorite-btn");
    const favoriteCountSpan = document.getElementById("favorite-count");

    // åˆå§‹åŒ–ç‚¹èµçŠ¶æ€
    fetch(`/like/status/${postId}`)
            .then(res => res.json())
            .then(data => {
              likeBtn.innerHTML = (data.liked ? '<i class="bi bi-heart-fill text-danger"></i> å·²ç‚¹èµ' : '<i class="bi bi-heart"></i> ç‚¹èµ');
              likeCountSpan.textContent = data.likeCount;
            });

    // åˆå§‹åŒ–æ”¶è—çŠ¶æ€
    fetch(`/favorite/status/${postId}`)
            .then(res => res.json())
            .then(data => {
              favoriteBtn.innerHTML = (data.favorited ? '<i class="bi bi-star-fill text-warning"></i> å·²æ”¶è—' : '<i class="bi bi-star"></i> æ”¶è—');
              favoriteCountSpan.textContent = data.favoriteCount;
            });

    // ç‚¹èµ
    likeBtn?.addEventListener("click", () => {
      fetch(`/like/${postId}`, { method: "POST" })
              .then(res => res.json())
              .then(data => {
                likeBtn.innerHTML = (data.liked ? '<i class="bi bi-heart-fill text-danger"></i> å·²ç‚¹èµ' : '<i class="bi bi-heart"></i> ç‚¹èµ');
                likeCountSpan.textContent = data.likeCount;
              });
    });

    // æ”¶è—
    favoriteBtn?.addEventListener("click", () => {
      fetch(`/favorite/${postId}`, { method: "POST" })
              .then(res => res.json())
              .then(data => {
                favoriteBtn.innerHTML = (data.favorited ? '<i class="bi bi-star-fill text-warning"></i> å·²æ”¶è—' : '<i class="bi bi-star"></i> æ”¶è—');
                favoriteCountSpan.textContent = data.favoriteCount;
              });
    });
  });
</script>
</body>
</html>