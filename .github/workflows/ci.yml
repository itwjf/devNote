name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

env:
  MAVEN_OPTS: -Xmx1024m

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Wait for MySQL to be ready
      run: |
        echo "Waiting for MySQL to be ready..."
        for i in {1..30}; do
          if mysqladmin ping -h"127.0.0.1" -P"3306" -u"root" -p"testpass" --silent; then
            echo "MySQL is ready!"
            break
          fi
          echo "Attempt $i: MySQL not ready, waiting..."
          sleep 2
        done

    - name: Run tests
      run: |
        mvn clean test \
          -Dspring.datasource.url=jdbc:mysql://localhost:3306/testdb \
          -Dspring.datasource.username=root \
          -Dspring.datasource.password=testpass \
          -Dspring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver \
          -Dspring.jpa.hibernate.ddl-auto=create-drop \
          -Dspring.flyway.enabled=false

    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Maven Tests
        path: target/surefire-reports/*.xml
        reporter: java-junit

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          target/surefire-reports/
          target/failsafe-reports/

  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build application
      run: mvn clean package -DskipTests

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: target/*.jar

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run dependency check
      run: |
        mvn org.owasp:dependency-check-maven:check \
          -DskipTests \
          -DfailBuildOnCVSS=7

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan
        path: target/dependency-check-report.html

  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Run Checkstyle
      run: |
        mvn checkstyle:check \
          -Dcheckstyle.config.location=checkstyle.xml \
          -Dcheckstyle.failOnViolation=true || true

    - name: Run SpotBugs
      run: |
        mvn spotbugs:check \
          -Dspotbugs.failOnError=true || true

    - name: Upload code quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          target/checkstyle-result.xml
          target/spotbugsXml.xml